import logging
import argparse
import requests
import urllib3
import sqlite3
import os
import sys
import csv
import hashlib
import pprint

CREATE_DORKS_TABLE = '''CREATE TABLE IF NOT EXISTS Dorks(
    DORK_SHA256 TEXT,
    DATE_ADDED DATE,
    DORK TEXT,
    CATEGORY TEXT,
    AUTHOR TEXT
);'''

class DB:
    def __init__(self, dbfilename='data.db'):
        """
        Constructor: initial setup for the class including default scripts, connection
        @param dbfilename: filename for database
        @return: class instance
        """
        logging.debug('Instance of DBAccess class was created.')
        self.dbfilename = dbfilename
        self.connection = None

        if not self.is_database_file():
            self.create_new_database()

        self.get_database_connection()


    def __del__(self):
        """
        Destructor: closes connection to database
        """
        logging.debug('Instance of DBAccess class was destroyed.')
        if type(self.connection) == sqlite3.Connection:
            self.connection.close()

    def is_database_file(self):
        """
        Checks if database file exists
        @return: True if exists, false otherwise
        """
        logging.debug(f'Check if database file {self.dbfilename} is on disk.')
        if os.path.isfile(self.dbfilename):
            return True
        return False


    def get_database_connection(self):
        """
        Get connection and cursor for current database
        """
        logging.debug('Establish database connection.')
        try:
            self.connection = sqlite3.connect(self.dbfilename)
            self.cursor = self.connection.cursor()
            return
        except sqlite3.Error as e:
            logging.error(f'Error: Could not connect to the DB: {e}')

        except Exception as e:
            logging.error(f'Error: Could not connect to the DB: {e}')

        exit('Error occurred when connecting to DB. Read the log file')

    def create_new_database(self):
        """
        Creates new database and tables
        @return: True if successful, exits the entire script otherwise
        """
        logging.info('Creating new tables in database.')
        self.get_database_connection()

        try:
            self.cursor.execute(CREATE_DORKS_TABLE)
            return True
        except sqlite3.Error as e:
            logging.error(f'ERROR Creating new DB - Database error: {e}')
        except Exception as e:
            logging.error(f'ERROR Creating new DB: {e}')

        exit('Error occurred when creating new DB. Read the log file')


    def add_dork(self, date_added, dork, categ, author):
        """
        Add Dork in database
        @return: True is successful, False otherwise
        """
        dork_sha256 = hashlib.sha256(dork.encode()).hexdigest()

        try:
            query = f'INSERT INTO Dorks VALUES({dork_sha256}, {date_added}, {dork}, {categ}, {author})'
            self.cursor.execute(query)
        except sqlite3.Error as e:
            logging.error('ERROR: Database error when inserting {}: {}'.format(dork, e))
            return False
        except Exception as e:
            logging.error('ERROR: {}'.format(e))
            return False

        self.connection.commit()
        return True


    def lookup_dork(self, keyword):
        """
        Add Dork in database
        @return: True is successful, False otherwise
        """

        results = []
        #TODO implement select after keyword
        query = f'SELECT * where dork like '%{keywork}%'
        


        return results


def display_dorks(results):
    """
    Display dorks
    """
    # TODO: Add multiple options
    pp = pprint.PrettyPrinter(indent=4)
    pp.pprint(results)


def main(download, lookup, search, db_file):
    db = DB(db_file)

    if download:
        #TODO add scraping from ExploitDB
        print("Downloading dorks from ExploitDB")

    if lookup or search:
        results = db.lookup_dork(lookup)
        display_dorks(results)
        if search:
            #TODO implement google search
            print("Searching Dorks on Google")


if __name__ == '__main__':
    parser = argparse.ArgumentParser(description='Google Hacking Database Scraper and Lookup tool')
    options = parser.add_mutually_exclusive_group()
    options.add_argument('-d', '--download', action='store_true', help='Download dorks from ExploitDB')
    options.add_argument('-l', '--lookup', type=str, help='Lookup specific Dorks in the local DB')

    parser.add_argument('-s', '--search', type=str, help='Search on Google using matching Dorks')
    parser.add_argument('-db', '--database', type=str, default='ghdb.db',
                        help='Specify database name. Default="ghdb.db"')
    parser.add_argument('--debug', action='store_true',
                        help='This argument enables DEBUG logging without modifying the script.')

    args = parser.parse_args()

    log_filename = 'ghdb.log'
    if args.database != 'ghdb.db':
        log_filename = 'ghdb%s.log' % os.path.basename(args.database).split('.')[0]

    log_path = os.path.join(os.getcwd(), log_filename)
    print(f'For any issues read the log: "tail -F {log_path}"')

    logFormat = "%(asctime)s:%(levelname)s:%(threadName)s:%(funcName)s:%(lineno)d: %(message)s"
    logging.basicConfig(level=logging.DEBUG if args.debug else logging.ERROR, filename=log_path, format=logFormat)

    logging.info('Welcome to GHDB Scraper. Starting magic...')
    logging.info('Passed arguments: {}'.format(args))

    main(args.download, args.lookup, args.search, args.database)